#!/bin/bash
# Agora AI Council - 全局命令
# 可以在任何目录运行，自动使用当前目录作为项目路径

# 脚本实际位置（支持符号链接）
SOURCE="${BASH_SOURCE[0]}"
# 解析符号链接，找到真实的脚本路径
while [ -h "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
AGORA_HOME="$(cd -P "$(dirname "$SOURCE")" && pwd)"

# 默认使用当前工作目录作为项目路径
PROJECT_PATH="$(pwd)"
CUSTOM_PATH=""

# 解析命令行参数
while getopts "p:h" opt; do
  case $opt in
    p)
      CUSTOM_PATH="$OPTARG"
      PROJECT_PATH="$OPTARG"
      ;;
    h)
      echo "Agora - AI圆桌会议系统"
      echo ""
      echo "用法: agora [-p 项目路径]"
      echo ""
      echo "选项:"
      echo "  -p PATH    指定项目路径（默认：当前目录）"
      echo "  -h         显示帮助"
      echo ""
      echo "示例:"
      echo "  agora                           # 使用当前目录"
      echo "  cd /path/to/project && agora    # 在项目目录运行"
      echo "  agora -p /path/to/project       # 指定路径"
      echo ""
      echo "当前目录: $(pwd)"
      echo "Agora安装目录: $AGORA_HOME"
      exit 0
      ;;
    \?)
      echo "无效选项: -$OPTARG" >&2
      echo "使用 -h 查看帮助"
      exit 1
      ;;
  esac
done

echo "🤖 Agora AI Council"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# 配置文件优先级（从高到低）：
# 1. 系统环境变量（最高优先级）
# 2. 用户配置：~/.config/agora/.env
# 3. 项目配置：安装目录/.env

USER_CONFIG="$HOME/.config/agora/.env"
PROJECT_CONFIG="$AGORA_HOME/.env"

# 加载配置（按优先级）
if [ -f "$USER_CONFIG" ]; then
    echo "📝 加载用户配置: $USER_CONFIG"
    export $(grep -v '^#' "$USER_CONFIG" | grep -v '^$' | xargs)
elif [ -f "$PROJECT_CONFIG" ]; then
    echo "📝 加载项目配置: $PROJECT_CONFIG"
    export $(grep -v '^#' "$PROJECT_CONFIG" | grep -v '^$' | xargs)
fi

# 检查 Token 是否配置
if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
    echo "❌ 错误: TELEGRAM_BOT_TOKEN 未配置！"
    echo ""
    echo "请选择以下方式之一配置："
    echo ""
    echo "方式 1（推荐）- 用户配置文件："
    echo "  mkdir -p ~/.config/agora"
    echo "  cp $AGORA_HOME/.env.example ~/.config/agora/.env"
    echo "  nano ~/.config/agora/.env"
    echo ""
    echo "方式 2 - 项目配置文件："
    echo "  cp $AGORA_HOME/.env.example $AGORA_HOME/.env"
    echo "  nano $AGORA_HOME/.env"
    echo ""
    echo "方式 3 - 环境变量："
    echo "  export TELEGRAM_BOT_TOKEN='your_token_here'"
    echo ""
    exit 1
fi

# 检查 Python 脚本
if [ ! -f "$AGORA_HOME/main.py" ]; then
    echo "❌ 错误: main.py 不存在！"
    echo "   路径: $AGORA_HOME/main.py"
    exit 1
fi

# 检查 python-dotenv
python3 -c "import dotenv" 2>/dev/null
if [ $? -ne 0 ]; then
    echo "⚠️  python-dotenv 未安装，正在安装..."
    pip3 install python-dotenv >/dev/null 2>&1
fi

# 显示项目路径
if [ -n "$CUSTOM_PATH" ]; then
    echo "📁 项目路径: $PROJECT_PATH (指定)"
else
    echo "📁 项目路径: $PROJECT_PATH (当前目录)"
fi

# 检查项目路径是否存在
if [ ! -d "$PROJECT_PATH" ]; then
    echo "⚠️  警告: 项目路径不存在: $PROJECT_PATH"
    echo "   Bot仍会启动，但AI无法读取项目文件"
fi

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# 设置项目路径环境变量
export PROJECT_ROOT="$PROJECT_PATH"

# 切换到 Agora 目录并启动
cd "$AGORA_HOME"
python3 main.py
