# Agora 架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              AGORA 架构图                                        │
│                     多 AI 协作讨论 Telegram Bot 系统                              │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              用户交互层                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Telegram Bot                                      │   │
│  │   用户消息  ──────────►  handlers.py  ◄──────  callbacks.py              │   │
│  │                              │                      │                    │   │
│  │   命令: /start /discuss /stop /ls /clear /sessions │                    │   │
│  │                                                     │                    │   │
│  │   特殊语法: --N 指定历史条数 (如 --5 问个问题)       │ 文件写入审批       │   │
│  └──────────────────────────────┼──────────────────────┼────────────────────┘   │
└─────────────────────────────────┼──────────────────────┼────────────────────────┘
                                  │                      │
                                  ▼                      │
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              智能路由层                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        router.py (SmartRouter)                           │   │
│  │                                                                          │   │
│  │   路由优先级 (7层):                                                       │   │
│  │   ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │   │ 1. 明确提及 (@Claude, codex帮我...) - 区分调用vs引用             │   │   │
│  │   │ 2. 回复消息 (回复某AI的消息)                                      │   │   │
│  │   │ 3. 讨论关键词 (讨论、大家、一起)                                   │   │   │
│  │   │ 4. 意图关键词 (架构→Claude, 写代码→Codex)                         │   │   │
│  │   │ 5. 继续上次对话 (last_agent)                                      │   │   │
│  │   │ 6. AI智能路由 (调用Claude判断)                                    │   │   │
│  │   │ 7. 默认: Claude                                                   │   │   │
│  │   └─────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                          │   │
│  │   调用模式 (触发AI):              引用模式 (不触发):                      │   │
│  │   • @claude, claude:              • claude说的, claude他                 │   │
│  │   • claude帮我, 问问codex         • claude的回答, claude的观点           │   │
│  │   • codex和gemini                                                        │   │
│  │                              │                                           │   │
│  │                    ┌─────────┼─────────┐                                 │   │
│  │                    ▼         ▼         ▼                                 │   │
│  │              ┌─────────┐ ┌─────────┐ ┌──────────┐                        │   │
│  │              │ SINGLE  │ │MULTIPLE │ │DISCUSSION│                        │   │
│  │              │ (单AI)  │ │(多AI并行)│ │ (圆桌)   │                        │   │
│  │              └────┬────┘ └────┬────┘ └────┬─────┘                        │   │
│  └───────────────────┼──────────┼───────────┼───────────────────────────────┘   │
└──────────────────────┼──────────┼───────────┼───────────────────────────────────┘
                       │          │           │
                       ▼          ▼           ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              AI 执行层                                           │
│                                                                                  │
│  ┌─────────────────────────────┐    ┌──────────────────────────────────────┐    │
│  │      runner.py              │    │      roundtable.py                   │    │
│  │                             │    │      (圆桌讨论引擎)                   │    │
│  │  run_agent_cli_async()      │    │                                      │    │
│  │  ┌───────────────────────┐  │    │   ┌────────────────────────────┐    │    │
│  │  │ • 构建命令            │  │    │   │ Round N:                   │    │    │
│  │  │ • 管理会话ID          │  │    │   │                            │    │    │
│  │  │ • 注入对话历史上下文  │  │    │   │  📝 提案阶段 (并行)        │    │    │
│  │  │ • 活动超时监控        │  │◄───┼───│     ↓                      │    │    │
│  │  │ • 可取消任务          │  │    │   │  📋 评审阶段 (并行)        │    │    │
│  │  │ • 进程追踪/清理       │  │    │   │     ↓                      │    │    │
│  │  └───────────────────────┘  │    │   │  🎯 计算最佳方案           │    │    │
│  │                             │    │   │     ↓                      │    │    │
│  └─────────────┬───────────────┘    │   │  ✓ 收敛检测                │    │    │
│                │                    │   │    (分数≥90 或 增幅<5)     │    │    │
│                ▼                    │   └────────────────────────────┘    │    │
│  ┌─────────────────────────────┐    │                                      │    │
│  │   外部 AI CLI 工具          │    │   state.py (DiscussionState)         │    │
│  │                             │    │   • 管理讨论状态                     │    │
│  │  ┌───────┐ ┌───────┐ ┌───────┐   │   • 追踪提案和评分                   │    │
│  │  │🔷     │ │🟢     │ │🔶     │   │   • 收敛判断                         │    │
│  │  │Claude │ │Codex  │ │Gemini │   │                                      │    │
│  │  │架构师 │ │工程师 │ │审查员 │   │                                      │    │
│  │  └───────┘ └───────┘ └───────┘   └──────────────────────────────────────┘    │
│  │                             │                                                 │
│  └─────────────────────────────┘                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              会话管理层                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        manager.py                                        │   │
│  │                                                                          │   │
│  │   ┌─────────────────────────────┐  ┌─────────────────────────────────┐  │   │
│  │   │  AI 会话 (chat_sessions)    │  │  对话历史 (chat_history)        │  │   │
│  │   │                             │  │                                 │  │   │
│  │   │  chat_id: {                 │  │  chat_id: [                     │  │   │
│  │   │    "Claude": "uuid-xxx",    │  │    {role: "user", content},     │  │   │
│  │   │    "Codex": "session-yyy",  │  │    {role: "Claude", content},   │  │   │
│  │   │    "Gemini": "gemini-zzz"   │  │    ...                          │  │   │
│  │   │  }                          │  │  ]                              │  │   │
│  │   └─────────────────────────────┘  └─────────────────────────────────┘  │   │
│  │                                                                          │   │
│  │                              ↕ 同步                                       │   │
│  │                                                                          │   │
│  │   持久化: ~/.config/agora/sessions.json                                  │   │
│  │   • sessions: AI会话ID映射                                               │   │
│  │   • last_agent: 最近对话的AI                                             │   │
│  │   • history: 对话历史 (默认2条, --N可指定)                               │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              工具层                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │
│  │ telegram.py │  │ project.py  │  │ markdown.py │  │      config.py          │ │
│  │             │  │             │  │             │  │                         │ │
│  │ • 长消息    │  │ • 项目树    │  │ • MD转义    │  │ • AI配置 (AGENTS)       │ │
│  │   分割发送  │  │ • 上下文    │  │             │  │ • 讨论参数              │ │
│  │ • 文件附件  │  │   构建      │  │             │  │ • 超时设置              │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  │ • 路由关键词            │ │
│                                                      └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 目录结构

```
agora/
├── main.py                 # 入口文件
├── config.py               # 配置管理
├── agora                   # Bash启动脚本
├── agents/                 # AI代理模块
│   ├── router.py           # 智能路由器 (调用vs引用识别)
│   └── runner.py           # AI CLI执行器
├── bot/                    # Telegram Bot处理
│   ├── handlers.py         # 命令和消息处理 (--N参数解析)
│   └── callbacks.py        # 按钮回调处理
├── discussion/             # 讨论机制
│   ├── roundtable.py       # 圆桌讨论逻辑
│   └── state.py            # 讨论状态管理
├── session/                # 会话管理
│   └── manager.py          # 会话+历史持久化
└── utils/                  # 工具函数
    ├── telegram.py         # 消息发送工具
    ├── project.py          # 项目上下文
    └── markdown.py         # Markdown转义
```

## 命令列表

| 命令 | 功能 |
|------|------|
| `/start` | 显示帮助信息 |
| `/discuss <话题>` | 手动启动圆桌讨论 |
| `/stop` | 立即终止讨论和所有AI进程 |
| `/ls` | 列出项目文件 |
| `/clear` | 清空所有会话和对话历史 |
| `/clear_session [AI]` | 清空指定AI的会话 |
| `/sessions` | 查看当前会话状态 |

## 特殊语法

### 指定历史条数
```
--N <消息内容>
```
- 默认传递最近 **2条** 对话历史
- 使用 `--5 codex帮我看看` 传递最近5条
- 范围限制: 1-20条

### AI调用方式
```
@claude 问题           # 明确调用
claude: 问题           # 冒号调用
codex和gemini 问题     # 并行调用
讨论一下...            # 触发圆桌讨论
```

### 引用 vs 调用
```
codex你觉得claude说的对吗?
       ↓
只触发 Codex, 不触发 Claude (因为"claude说的"是引用)
```

## 数据流

```
用户消息: "--5 codex和gemini你们觉得呢，claude他说的对吗"
                │
                ▼
        ┌───────────────┐
        │ 解析 --5      │ → history_limit = 5
        └───────┬───────┘
                │
                ▼
        ┌───────────────┐
        │ 智能路由      │ → Codex ✓, Gemini ✓, Claude ✗(引用)
        └───────┬───────┘
                │
                ▼
        ┌───────────────┐
        │ 获取历史(5条) │ → [user: "1+1", Claude: "2", ...]
        └───────┬───────┘
                │
        ┌───────┴───────┐
        ▼               ▼
   ┌─────────┐    ┌─────────┐
   │  Codex  │    │ Gemini  │  (并行调用, 带历史上下文)
   └─────────┘    └─────────┘
        │               │
        ▼               ▼
   保存回复到历史, 发送给用户
```
